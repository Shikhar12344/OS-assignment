{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "43bea8ec",
   "metadata": {},
   "outputs": [],
   "source": [
    "import warnings\n",
    "warnings.filterwarnings(\"ignore\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3478bb24",
   "metadata": {},
   "source": [
    "***Task 1***"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "9d09996c",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "--- Task 1: Process Creation Utility ---\n",
      "[Notebook] My PID is 450. Launching 3 child processes...\n",
      "\n",
      "\n",
      "[Notebook] Waiting for all child processes to complete...\n",
      "[Child 3] My PID is 519 and my Parent's PID is 450.\n",
      "[Child 1] My PID is 517 and my Parent's PID is 450.\n",
      "[Child 2] My PID is 518 and my Parent's PID is 450.\n",
      "[Notebook] All children have completed.\n"
     ]
    }
   ],
   "source": [
    "import subprocess\n",
    "import os\n",
    "\n",
    "print(\"--- Task 1: Process Creation Utility ---\")\n",
    "N = 3\n",
    "parent_pid = os.getpid()\n",
    "print(f\"[Notebook] My PID is {parent_pid}. Launching {N} child processes...\\n\")\n",
    "\n",
    "# A list to hold our running process objects\n",
    "processes = []\n",
    "\n",
    "for i in range(N):\n",
    "    # Command to be executed by the new process\n",
    "    # It prints its own PID and its parent's PID\n",
    "    command = f\"import os, time; print(f'[Child {i+1}] My PID is {{os.getpid()}} and my Parent\\\\'s PID is {{os.getppid()}}.'); time.sleep(1)\"\n",
    "    \n",
    "    # Launch the process\n",
    "    # Popen is non-blocking, so all children start in parallel\n",
    "    proc = subprocess.Popen([\"python3\", \"-c\", command])\n",
    "    processes.append(proc)\n",
    "\n",
    "print(\"\\n[Notebook] Waiting for all child processes to complete...\")\n",
    "\n",
    "# Wait for each process to finish\n",
    "for proc in processes:\n",
    "    proc.wait()\n",
    "\n",
    "print(\"[Notebook] All children have completed.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "44e5d103",
   "metadata": {},
   "source": [
    "***Task 2***"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "f2d5a104",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "--- Task 2: Command Execution Using exec() ---\n",
      "\n",
      "--- Running Command: 'ls -l' ---\n",
      "total 48\n",
      "-rw-r--r--. 1 parallels parallels  3288 Sep 28 14:40 Linux.ipynb\n",
      "-rw-r--r--. 1 parallels parallels  4863 Aug 16 16:48 OSIntro.ipynb\n",
      "-rw-r--r--. 1 parallels parallels 22879 Sep 22 12:22 OSLabAss1.ipynb\n",
      "-rw-r--r--. 1 parallels parallels    20 Aug 14 12:19 src.txt\n",
      "-rw-r--r--. 1 parallels parallels   243 Aug 14 11:47 system_info copy.txt\n",
      "-rw-r--r--. 1 parallels parallels   243 Aug 14 11:42 system_info.txt\n",
      "\n",
      "\n",
      "--- Running Command: 'date' ---\n",
      "Sunday 28 September 2025 02:40:07 PM IST\n",
      "\n",
      "\n",
      "--- Running Command: 'whoami' ---\n",
      "parallels\n",
      "\n",
      "\n",
      "--- All commands executed. ---\n"
     ]
    }
   ],
   "source": [
    "import subprocess\n",
    "\n",
    "print(\"--- Task 2: Command Execution Using exec() ---\")\n",
    "commands = [\"ls -l\", \"date\", \"whoami\"]\n",
    "\n",
    "for cmd_str in commands:\n",
    "    print(f\"\\n--- Running Command: '{cmd_str}' ---\")\n",
    "    \n",
    "    # subprocess.run() executes a command and waits for it to complete\n",
    "    result = subprocess.run(\n",
    "        cmd_str.split(), \n",
    "        capture_output=True, \n",
    "        text=True\n",
    "    )\n",
    "    \n",
    "    # Print the standard output from the command\n",
    "    print(result.stdout)\n",
    "\n",
    "print(\"\\n--- All commands executed. ---\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0d844176",
   "metadata": {},
   "source": [
    "***Task 3***"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "be43461d",
   "metadata": {},
   "source": [
    "Helper Script"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "654677e7",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Writing zombie_maker.py\n"
     ]
    }
   ],
   "source": [
    "%%writefile zombie_maker.py\n",
    "import os\n",
    "import time\n",
    "\n",
    "pid = os.fork()\n",
    "if pid == 0:\n",
    "    # Child process\n",
    "    print(f\"Child ({os.getpid()}) exiting immediately.\")\n",
    "    os._exit(0)\n",
    "else:\n",
    "    # Parent process\n",
    "    print(f\"Parent ({os.getpid()}) is running but NOT waiting for child {pid}.\")\n",
    "    print(\"==> The child is now a zombie. Check 'ps -el | grep defunct' in your terminal.\")\n",
    "    time.sleep(20) # Keep the parent alive so the zombie state persists\n",
    "    os.wait() # Clean up the zombie after 20 seconds\n",
    "    print(\"Parent has now reaped the child. Zombie is gone.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "265d6edd",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Writing orphan_maker.py\n"
     ]
    }
   ],
   "source": [
    "%%writefile orphan_maker.py\n",
    "import subprocess\n",
    "import os\n",
    "import time\n",
    "\n",
    "print(f\"Parent ({os.getpid()}) is launching a child process.\")\n",
    "# Launch the child and redirect its output to a file\n",
    "with open(\"child_output.txt\", \"w\") as f:\n",
    "    subprocess.Popen([\"python3\", \"long_running_child.py\"], stdout=f, stderr=f)\n",
    "\n",
    "print(f\"Parent ({os.getpid()}) is exiting immediately, orphaning the child.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "8e534198",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Writing long_running_child.py\n"
     ]
    }
   ],
   "source": [
    "%%writefile long_running_child.py\n",
    "import os\n",
    "import time\n",
    "\n",
    "# This output will go to 'child_output.txt'\n",
    "original_ppid = os.getppid()\n",
    "time.sleep(2) # Give parent time to exit\n",
    "new_ppid = os.getppid()\n",
    "\n",
    "print(f\"Child ({os.getpid()}) started with parent {original_ppid}.\")\n",
    "print(f\"Child ({os.getpid()}) is now an orphan, adopted by parent {new_ppid}.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "6a9a00cd",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "import os\n",
      "import time\n",
      "\n",
      "pid = os.fork()\n",
      "if pid == 0:\n",
      "    # Child process\n",
      "    print(f\"Child ({os.getpid()}) exiting immediately.\")\n",
      "    os._exit(0)\n",
      "else:\n",
      "    # Parent process\n",
      "    print(f\"Parent ({os.getpid()}) is running but NOT waiting for child {pid}.\")\n",
      "    print(\"==> The child is now a zombie. Check 'ps -el | grep defunct' in your terminal.\")\n",
      "    time.sleep(20) # Keep the parent alive so the zombie state persists\n",
      "    os.wait() # Clean up the zombie after 20 seconds\n",
      "    print(\"Parent has now reaped the child. Zombie is gone.\")\n"
     ]
    }
   ],
   "source": [
    "!cat zombie_maker.py"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ccfbce17",
   "metadata": {},
   "source": [
    "Zombie Simulation"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4eab233d",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "--- Task 3: Creating a Zombie Process ---\n",
      "--> The script is running. Quickly open a terminal in VS Code and run:\n",
      "    ps -el | grep defunct\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Parent (608) is running but NOT waiting for child 609.\n",
      "==> The child is now a zombie. Check 'ps -el | grep defunct' in your terminal.\n",
      "Child (609) exiting immediately.\n",
      "Parent has now reaped the child. Zombie is gone.\n"
     ]
    }
   ],
   "source": [
    "import subprocess\n",
    "\n",
    "print(\"--- Task 3: Creating a Zombie Process ---\")\n",
    "# This will now execute the clean zombie_maker.py script\n",
    "subprocess.Popen([\"python3\", \"zombie_maker.py\"])\n",
    "\n",
    "print(\"--> The script is running. Quickly open a terminal in VS Code and run:\")\n",
    "print(\"    ps -el | grep defunct\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1c0e8f3f",
   "metadata": {},
   "source": [
    "Orphan Simulation"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "8c592655",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "--- Task 3: Creating an Orphan Process ---\n",
      "Parent (615) is launching a child process.\n",
      "Parent (615) is exiting immediately, orphaning the child.\n",
      "\n",
      "Parent script has finished. The child is now an orphan running in the background.\n",
      "Waiting for the child to finish and write its output...\n",
      "\n",
      "--- Contents of child_output.txt ---\n",
      "Child (616) started with parent 1.\n",
      "Child (616) is now an orphan, adopted by parent 1.\n",
      "\n"
     ]
    }
   ],
   "source": [
    "import subprocess\n",
    "import time\n",
    "\n",
    "print(\"--- Task 3: Creating an Orphan Process ---\")\n",
    "\n",
    "# Run the parent script that creates an orphan\n",
    "subprocess.run([\"python3\", \"orphan_maker.py\"])\n",
    "\n",
    "print(\"\\nParent script has finished. The child is now an orphan running in the background.\")\n",
    "print(\"Waiting for the child to finish and write its output...\")\n",
    "time.sleep(5) # Wait for the child process to complete\n",
    "\n",
    "# Display the output from the orphaned child\n",
    "print(\"\\n--- Contents of child_output.txt ---\")\n",
    "with open(\"child_output.txt\", \"r\") as f:\n",
    "    print(f.read())"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b904e33c",
   "metadata": {},
   "source": [
    "***Task 4***"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "53fd16c7",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "--- Task 4: Inspecting Process Info from /proc ---\n",
      "\n",
      "--- Details for Process PID: 91 ---\n",
      "\n",
      "[+] Process Status:\n",
      "  - Name:\tcode\n",
      "  - State:\tS (sleeping)\n",
      "  - Pid:\t91\n",
      "  - PPid:\t34\n",
      "  - VmRSS:\t  340156 kB\n",
      "\n",
      "[+] Executable Path: Not accessible.\n"
     ]
    }
   ],
   "source": [
    "import os\n",
    "\n",
    "print(\"--- Task 4: Inspecting Process Info from /proc ---\")\n",
    "try:\n",
    "    # Get the PID of the notebook kernel itself as a default example\n",
    "    default_pid = os.getpid()\n",
    "    pid_str = input(f\"Enter the PID to inspect (e.g., this notebook's kernel: {default_pid}): \")\n",
    "    pid = int(pid_str)\n",
    "except ValueError:\n",
    "    print(\"Invalid PID.\")\n",
    "else:\n",
    "    proc_dir = f\"/proc/{pid}\"\n",
    "\n",
    "    if not os.path.isdir(proc_dir):\n",
    "        print(f\"Error: Process with PID {pid} does not exist.\")\n",
    "    else:\n",
    "        print(f\"\\n--- Details for Process PID: {pid} ---\")\n",
    "\n",
    "        # 1. Read /proc/[pid]/status\n",
    "        try:\n",
    "            with open(f\"{proc_dir}/status\", 'r') as f:\n",
    "                print(\"\\n[+] Process Status:\")\n",
    "                for line in f:\n",
    "                    if line.startswith(('Name:', 'State:', 'Pid:', 'PPid:', 'VmRSS:')):\n",
    "                        print(f\"  - {line.strip()}\")\n",
    "        except FileNotFoundError:\n",
    "            print(\"  - Could not read status file.\")\n",
    "\n",
    "        # 2. Read executable path\n",
    "        try:\n",
    "            exe_path = os.readlink(f\"{proc_dir}/exe\")\n",
    "            print(f\"\\n[+] Executable Path:\\n  - {exe_path}\")\n",
    "        except (FileNotFoundError, PermissionError):\n",
    "            print(f\"\\n[+] Executable Path: Not accessible.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a15fab84",
   "metadata": {},
   "source": [
    "***Task 5***"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "f996ad34",
   "metadata": {},
   "source": [
    "Helper Script"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "22165522",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Writing cpu_eater_robust.py\n"
     ]
    }
   ],
   "source": [
    "%%writefile cpu_eater_robust.py\n",
    "import os\n",
    "import sys\n",
    "import time\n",
    "\n",
    "def heavy_computation():\n",
    "    \"\"\"Simulates a CPU-intensive task.\"\"\"\n",
    "    count = 0\n",
    "    for _ in range(150_000_000):\n",
    "        count += 1\n",
    "\n",
    "# --- Main script logic ---\n",
    "if len(sys.argv) < 2:\n",
    "    print(\"Error: Missing nice value argument.\")\n",
    "    sys.exit(1)\n",
    "\n",
    "requested_nice = int(sys.argv[1])\n",
    "\n",
    "# Gracefully handle permission errors\n",
    "try:\n",
    "    os.nice(requested_nice)\n",
    "except PermissionError:\n",
    "    # If permission is denied, the nice value remains unchanged.\n",
    "    # We pass silently, as the goal is to not crash.\n",
    "    pass\n",
    "\n",
    "# Read the actual nice value after the attempt to set it.\n",
    "actual_nice = os.nice(0)\n",
    "start_time = time.time()\n",
    "\n",
    "heavy_computation()\n",
    "\n",
    "end_time = time.time()\n",
    "duration = end_time - start_time\n",
    "\n",
    "# Print a single, clean line of output for easy parsing.\n",
    "print(f\"PID: {os.getpid():<6} | Requested Nice: {requested_nice:<3} | Actual Nice: {actual_nice:<3} | Duration: {duration:.2f}s\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "abc28dc6",
   "metadata": {},
   "source": [
    "Process Prioritization"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "id": "e1e28444",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "--- Task 5: Process Prioritization (Jupyter Robust Version) ---\n",
      "Launching 3 child processes with nice values: [15, 0, -10]...\n",
      "Waiting for them to complete...\n",
      "\n",
      "--- Results ---\n",
      "PID: 679    | Requested Nice: -10 | Actual Nice: 0   | Duration: 2.24s\n",
      "PID: 678    | Requested Nice: 0   | Actual Nice: 0   | Duration: 2.33s\n",
      "PID: 677    | Requested Nice: 15  | Actual Nice: 15  | Duration: 2.37s\n",
      "\n",
      "--- Simulation Complete ---\n",
      "✅ Notice how the process that 'Requested Nice: -10' did not crash.\n",
      "   Instead, it ran at the default 'Actual Nice: 0' because of the error handling.\n"
     ]
    }
   ],
   "source": [
    "import subprocess\n",
    "\n",
    "print(\"--- Task 5: Process Prioritization (Jupyter Robust Version) ---\")\n",
    "\n",
    "# We will request a high priority (-10) to test the robust error handling.\n",
    "nice_values = [15, 0, -10] # Low Prio, Normal Prio, High Prio (will likely fail)\n",
    "processes = []\n",
    "\n",
    "print(f\"Launching 3 child processes with nice values: {nice_values}...\")\n",
    "print(\"Waiting for them to complete...\\n\")\n",
    "\n",
    "for val in nice_values:\n",
    "    # Launch each process using the robust helper script\n",
    "    proc = subprocess.Popen(\n",
    "        [\"python3\", \"cpu_eater_robust.py\", str(val)],\n",
    "        stdout=subprocess.PIPE,\n",
    "        text=True\n",
    "    )\n",
    "    processes.append(proc)\n",
    "\n",
    "# --- Collect and display results ---\n",
    "print(\"--- Results ---\")\n",
    "results = []\n",
    "for proc in processes:\n",
    "    output, _ = proc.communicate() # Wait for process to finish and get output\n",
    "    results.append(output.strip())\n",
    "\n",
    "# Sort the results by duration to make the priority effect obvious\n",
    "results.sort(key=lambda x: float(x.split('Duration: ')[1].replace('s', '')))\n",
    "for res in results:\n",
    "    print(res)\n",
    "\n",
    "print(\"\\n--- Simulation Complete ---\")\n",
    "print(\"✅ Notice how the process that 'Requested Nice: -10' did not crash.\")\n",
    "print(\"   Instead, it ran at the default 'Actual Nice: 0' because of the error handling.\")"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "base",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.13.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
